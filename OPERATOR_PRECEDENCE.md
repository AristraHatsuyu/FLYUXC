# FLYUXC 运算符优先级参考

## 快速参考表

| 优先级 | 运算符 | 说明 | 结合性 | 示例 |
|--------|--------|------|--------|------|
| 1 (最高) | `()` `[]` `.` `.>` | 后缀运算符 | L→R | `arr[0]`, `obj.prop` |
| 2 | `!` `+` `-` (一元) | 一元运算符 | R→L | `!flag`, `-x` |
| 3 | `**` | 幂运算 | L→R | `2**3` = 8 |
| 4 | `*` `/` `%` | 乘除模 | L→R | `a*b`, `a/b` |
| 5 | `+` `-` | 加减 | L→R | `a+b`, `a-b` |
| 6 | `<` `<=` `>` `>=` | 比较运算 | L→R | `a<b`, `a>=b` |
| 7 | `==` `!=` | 相等运算 | L→R | `a==b`, `a!=b` |
| 8 | `&` | 位与 | L→R | `a&b` |
| 9 | `^` | 位异或 | L→R | `a^b` |
| 10 | `\|` | 位或 | L→R | `a\|b` |
| 11 | `&&` | 逻辑与 | L→R | `a&&b` |
| 12 | `\|\|` | 逻辑或 | L→R | `a\|\|b` |
| 13 | `=` `:=` | 赋值 | R→L | `a:=b` |
| 14 (最低) | `,` | 逗号 | L→R | `a,b,c` |

---

## 常见表达式示例

### 1. 位运算与逻辑运算

```fx
a | b && c & d
// 计算顺序: c&d → a|b → (a|b)&&(c&d)
// 因为: & (8) > | (10) > && (11)
```

### 2. 算术与位运算

```fx
a + b & c | d
// 计算顺序: a+b → (a+b)&c → ((a+b)&c)|d
// 因为: + (5) > & (8) > | (10)
```

### 3. 幂运算优先级

```fx
a ** b * c
// 计算顺序: a**b → (a**b)*c
// 因为: ** (3) > * (4)

a * b ** c
// 计算顺序: b**c → a*(b**c)
// 因为: ** (3) > * (4)
```

### 4. 比较与位运算

```fx
a == b & c
// 计算顺序: b&c → a==(b&c)
// 因为: & (8) > == (7)

a & b == c
// 计算顺序: a&b → (a&b)==c
// 因为: & (8) > == (7)
```

### 5. 复杂混合表达式

```fx
a**b * c + d & e ^ f | g
// 计算顺序:
// 1. a**b          (** 最高优先级)
// 2. (a**b)*c      (* 次之)
// 3. ((a**b)*c)+d  (+ 次之)
// 4. (((a**b)*c)+d)&e  (& 次之)
// 5. ((((a**b)*c)+d)&e)^f  (^ 次之)
// 6. (((((a**b)*c)+d)&e)^f)|g  (| 最后)
```

---

## 括号简化规则

FLYUXC 的 Normalizer 会根据优先级自动移除不必要的括号：

### 可以移除括号的情况

```fx
// 原始: (a + b) * c
// 归一化: (a+b)*c
// 说明: 需要保留，因为 + 比 * 优先级低

// 原始: (a * b) + c
// 归一化: a*b+c
// 说明: 可以移除，因为 * 比 + 优先级高

// 原始: (a | b) && c
// 归一化: a|b&&c
// 说明: 可以移除，因为 | 比 && 优先级高

// 原始: a | (b && c)
// 归一化: a|b&&c
// 说明: 可以移除，因为 && 会先于 | 计算
```

### 必须保留括号的情况

```fx
// 原始: (a + b) * c
// 归一化: (a+b)*c
// 说明: 必须保留，否则变成 a+(b*c)

// 原始: (a && b) || c
// 归一化: a&&b||c
// 说明: 可以移除，因为 && 优先级高于 ||

// 原始: a && (b || c)
// 归一化: a&&(b||c)
// 说明: 必须保留，否则变成 (a&&b)||c
```

---

## 实现细节

### FLYUXC 内部优先级枚举

位置: `src/core/normalize_format.c` 第72-90行

```c
enum {
    PREC_COMMA   = 5,
    PREC_ASSIGN  = 10,
    PREC_OR      = 20,   // ||
    PREC_AND     = 30,   // &&
    PREC_BW_OR   = 40,   // |
    PREC_BW_XOR  = 42,   // ^
    PREC_BW_AND  = 44,   // &
    PREC_EQ      = 48,   // == !=
    PREC_CMP     = 50,   // < > <= >=
    PREC_ADD     = 60,   // + -
    PREC_MUL     = 70,   // * / %
    PREC_POW     = 80,   // **
    PREC_UNARY   = 90,   // ! 一元 + -
    PREC_POSTFIX = 100   // . .> [] ()
};
```

**注意**: 在 FLYUXC 中，数值越大优先级越高（与 C 标准表相反）

---

## 与 C/C++/JavaScript 的对比

| 运算符 | FLYUXC | C/C++ | JavaScript | 备注 |
|--------|--------|-------|------------|------|
| `**` | ✅ | ❌ | ✅ | C/C++ 无此运算符 |
| `&` | 位与 | 位与 | 位与 | 完全相同 |
| `\|` | 位或 | 位或 | 位或 | 完全相同 |
| `^` | 位异或 | 位异或 | 位异或 | 完全相同 |
| `&&` | 逻辑与 | 逻辑与 | 逻辑与 | 完全相同 |
| `\|\|` | 逻辑或 | 逻辑或 | 逻辑或 | 完全相同 |
| `:=` | 定义赋值 | ❌ | ❌ | FLYUXC 特有 |

**优先级顺序**: FLYUXC 与 C/JavaScript 完全一致

---

## 测试验证

已通过C程序验证优先级正确性：

```c
int a=1, b=0, c=1, d=0;
printf("a|b&&c&d = %d\n", a|b&&c&d);          // 0
printf("(a|b)&&(c&d) = %d\n", (a|b)&&(c&d));  // 0 ✅ 相同
printf("a|(b&&(c&d)) = %d\n", a|(b&&(c&d)));  // 1 ❌ 不同
```

**结论**: 优先级 & > | > && 已验证正确 ✅
