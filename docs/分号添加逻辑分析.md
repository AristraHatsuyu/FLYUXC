# FLYUX ç¼–è¯‘å™¨ - åˆ†å·æ·»åŠ é€»è¾‘åˆ†æ

## ä¸€ã€FLYUX if ç»“æ„ä¸åˆ†å·è§„åˆ™ç†è§£

### 1.1 if ç»“æ„çš„è¯­æ³•
```
if(æ¡ä»¶1){
    è¯­å¥A
}(æ¡ä»¶2){
    è¯­å¥B
} {
    è¯­å¥C
}
```

### 1.2 ç¼–è¯‘è§„èŒƒ
- **æ¯ä¸ªè¯­å¥ï¼ˆå‘½ä»¤ï¼‰æœ¬èº«éƒ½ä»¥åˆ†å·ç»“å°¾**
- **æ•´ä¸ª if ç»“æ„æœ«å°¾æ·»åŠ åˆ†å·**
- å—å†…çš„è¯­å¥ä¸ä¸€å®šéƒ½éœ€è¦åˆ†å·ï¼ˆåªæœ‰å®é™…çš„è¯­å¥æ‰éœ€è¦ï¼‰

### 1.3 ç¼–è¯‘åå½¢å¼
```
if(...){è¯­å¥A;}(æ¡ä»¶2){è¯­å¥B;}{è¯­å¥C;};
```

å…³é”®ç‚¹ï¼š
- æ¯ä¸ªå— `{...}` å†…éƒ¨çš„è¯­å¥ä»¥åˆ†å·ç»“å°¾ï¼ˆå› ä¸ºè¯­å¥æœ¬èº«æœ‰åˆ†å·ï¼‰
- æ•´ä¸ª if ç»“æ„æœ«å°¾æ·»åŠ åˆ†å·
- ç®€å• ifï¼š`if(...){...;};`

---

## äºŒã€å½“å‰ä»£ç çš„åˆ†å·æ·»åŠ æœºåˆ¶

### 2.1 è§„èŒƒåŒ–ç®¡é“æµç¨‹

```
æºä»£ç 
  â†“
Step 1.5: normalize_internal_newlines() [å¤„ç†å—å†…æ¢è¡Œâ†’åˆ†å·]
  â†“
Step 2: normalize_split_statements() [åˆ†å‰²è¯­å¥]
  â†“
Step 3: normalize_filter_expressions() [è¿‡æ»¤è¡¨è¾¾å¼]
  â†“
Step 4: normalize_statement_content() [è§„èŒƒåŒ–æ¯ä¸ªè¯­å¥]
  â†“
Step 5: ç»„åˆè¯­å¥ï¼Œæ¯ä¸ªæœ«å°¾æ·»åŠ  `;`
```

### 2.2 å…³é”®å‡½æ•°ï¼šnormalize_internal_newlines()
**ä½ç½®**ï¼š`src/core/normalize.c`, ç¬¬ 65-180 è¡Œ

**èŒè´£**ï¼šåœ¨å—å†…å¤„ç†**æ¢è¡Œç¬¦**ï¼Œè½¬æ¢ä¸ºåˆ†å·

**åŸç†**ï¼š
```c
è·Ÿè¸ª brace_depth:
- é‡åˆ° { â†’ brace_depth++
- é‡åˆ° } â†’ brace_depth--
- å½“ brace_depth > 0 ä¸”é‡åˆ° \n â†’ æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ  ;

æ£€æŸ¥é€»è¾‘ï¼š
1. æ‰¾åˆ°æ¢è¡Œç¬¦ \n
2. æ£€æŸ¥ brace_depth > 0ï¼ˆåœ¨å—å†…ï¼‰
3. æ£€æŸ¥ paren_depth == 0ï¼ˆä¸åœ¨æ‹¬å·å†…ï¼‰
4. æ£€æŸ¥ bracket_depth == 0ï¼ˆä¸åœ¨æ–¹æ‹¬å·å†…ï¼‰
5. è·³è¿‡æ¢è¡Œåçš„ç©ºç™½ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªéç©ºå­—ç¬¦
6. å¦‚æœä¸æ˜¯ }ï¼ˆå—çš„ç»“å°¾ï¼‰ï¼Œæ·»åŠ åˆ†å·
```

**ç‰¹æ®Šå¤„ç†ï¼ˆç¬¬ 115-127 è¡Œï¼‰**ï¼š
```c
if (brace_depth == 1 && is_closing_function_body(result, out_idx)) {
    // æ£€æŸ¥å‡½æ•°ä½“æœ«å°¾æ˜¯å¦éœ€è¦åˆ†å·
    if (last >= 0 && result[last] != ';' && result[last] != '{') {
        æ·»åŠ åˆ†å·
    }
}
```
è¿™åªå¤„ç† `brace_depth == 1` çš„æƒ…å†µï¼ˆæœ€é¡¶å±‚å‡½æ•°ä½“ï¼‰

### 2.3 æœ€ç»ˆç»„åˆï¼ˆç¬¬ 263-270 è¡Œï¼‰
```c
for (int i = 0; i < stmt_count; i++) {
    strcpy(normalized + out_idx, normalized_stmts[i]);
    out_idx += len;
    normalized[out_idx++] = ';';  // åœ¨æ¯ä¸ªè¯­å¥åæ·»åŠ åˆ†å·
}
```

æ¯ä¸ªè¢«åˆ†å‰²çš„**è¯­å¥**æœ«å°¾è‡ªåŠ¨æ·»åŠ åˆ†å·

---

## ä¸‰ã€å½“å‰é—®é¢˜åˆ†æ

### 3.1 demo.fx ä¸­çš„é—®é¢˜

**åŸå§‹ä»£ç **ï¼š
```
if(...){
    ğŸ˜º[ğŸ¾] = ğŸš€.>ğŸ¤ªğŸ«µ(ğŸ‹)
}{
    ğŸ˜º[ğŸ¾] = ğŸš€ + ğŸ¾
    ğŸ“¢ := {ğŸ˜:"ğŸ›¬"}
}
```

**å½“å‰è¾“å‡º**ï¼š
```
if(...){ğŸ˜º[ğŸ¾]=ğŸš€.>ğŸ¤ªğŸ«µ(ğŸ‹)}{ğŸ˜º[ğŸ¾]=ğŸš€+ğŸ¾;ğŸ“¢:={ğŸ˜:"ğŸ›¬"}}
```

**ç¼ºå¤±çš„åˆ†å·**ï¼š
1. `ğŸš€.>ğŸ¤ªğŸ«µ(ğŸ‹)` åç¼ºå°‘åˆ†å·
2. `"ğŸ›¬"}` åç¼ºå°‘åˆ†å·ï¼ˆæœ€åä¸€ä¸ªè¯­å¥ `ğŸ“¢ := {ğŸ˜:"ğŸ›¬"}` çš„åˆ†å·ï¼‰

### 3.2 é—®é¢˜åŸå› 

#### é—®é¢˜ 1ï¼š`ğŸš€.>ğŸ¤ªğŸ«µ(ğŸ‹)` åç¼ºå°‘åˆ†å·

åŸå§‹ä»£ç ï¼š
```
if(...){
    ğŸ˜º[ğŸ¾] = ğŸš€.>ğŸ¤ªğŸ«µ(ğŸ‹)    â† åŸå§‹ä»£ç æ²¡æœ‰åˆ†å·ï¼Œæœ‰æ¢è¡Œ
}{
```

å¤„ç†è¿‡ç¨‹ï¼š
1. `normalize_internal_newlines()` é‡åˆ° `if` çš„ `{`ï¼Œ`brace_depth` å˜ä¸º 2
2. é‡åˆ°æ¢è¡Œ `\n`ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ªéç©ºå­—ç¬¦
3. ä¸‹ä¸€ä¸ªå­—ç¬¦æ˜¯ `}`ï¼ˆif çš„é—­æ‹¬å·ï¼‰ï¼Œæ‰€ä»¥**è·³è¿‡**è¿™ä¸ªæ¢è¡Œï¼ˆä¸æ·»åŠ åˆ†å·ï¼‰
4. å› ä¸ºåˆ¤æ–­é€»è¾‘æ˜¯ï¼š**å¦‚æœä¸‹ä¸€ä¸ªæ˜¯ `}`ï¼Œå°±ä¸æ·»åŠ åˆ†å·**

è¿™æ˜¯åˆç†çš„ï¼Œå› ä¸ºå—çš„ç»“å°¾ä¸åº”è¯¥åœ¨ `}` å‰æ·»åŠ åˆ†å·ã€‚

#### ä½†é—®é¢˜åœ¨äºï¼š

å½“ä»£ç å˜æˆ `}{` ï¼ˆif å—å’Œ else å—ç›¸é‚»ï¼‰æ—¶ï¼š
1. `}` é—­åˆäº† if å—
2. `{` å¼€å¯äº† else å—
3 ä¹‹é—´**æ²¡æœ‰æ¢è¡Œ**ï¼Œæ‰€ä»¥ `normalize_internal_newlines()` ä¸ä¼šå¤„ç†

**ç¼ºå¤±çš„åˆ†å·åº”è¯¥åœ¨**ï¼š
- `}` é—­åˆä¸€ä¸ªå—æ—¶ï¼Œæ£€æŸ¥å‰é¢æ˜¯å¦æœ‰æœªç»“å°¾çš„è¯­å¥

#### é—®é¢˜ 2ï¼šelse å—å†…æœ€åä¸€ä¸ªè¯­å¥ç¼ºå°‘åˆ†å·

åŸå§‹ä»£ç ï¼š
```
}{
    ğŸ˜º[ğŸ¾] = ğŸš€ + ğŸ¾
    ğŸ“¢ := {ğŸ˜:"ğŸ›¬"}    â† åŸå§‹ä»£ç æœ‰æ¢è¡Œ
}
```

å¤„ç†è¿‡ç¨‹ï¼š
1. else å—å†…ç¬¬ä¸€ä¸ªè¯­å¥ `ğŸ˜º[ğŸ¾] = ğŸš€ + ğŸ¾` åæœ‰æ¢è¡Œï¼Œåº”è¯¥è¢«è½¬ä¸ºåˆ†å· âœ“ï¼ˆå¯èƒ½å·²å¤„ç†ï¼‰
2. ç¬¬äºŒä¸ªè¯­å¥ `ğŸ“¢ := {ğŸ˜:"ğŸ›¬"}` åæœ‰æ¢è¡Œï¼Œä½†ä¸‹ä¸€ä¸ªæ˜¯ `}`
3. åˆ¤æ–­é€»è¾‘ï¼š**å¦‚æœä¸‹ä¸€ä¸ªæ˜¯ `}`ï¼Œè·³è¿‡æ¢è¡Œ** â†’ ä¸æ·»åŠ åˆ†å·

è¿™å¯¼è‡´æœ€åä¸€ä¸ªè¯­å¥æ²¡æœ‰åˆ†å·ã€‚

---

## å››ã€å½“å‰åˆ†å·æ·»åŠ çš„åŸç†æ€»ç»“

### 4.1 ä¸‰å±‚åˆ†å·æ·»åŠ æœºåˆ¶

| å±‚çº§ | æœºåˆ¶ | ä½ç½® | æ¡ä»¶ |
|------|------|------|------|
| 1 | å—å†…æ¢è¡Œâ†’åˆ†å· | `normalize_internal_newlines()` | `\n` åœ¨å—å†…ï¼Œä¸‹ä¸€ä¸ªéç©º â‰  `}` |
| 2 | å‡½æ•°ä½“æœ«å°¾åˆ†å· | `normalize_internal_newlines()` (line 115) | `brace_depth==1` ä¸”æ˜¯å‡½æ•°ä½“é—­æ‹¬å· |
| 3 | è¯­å¥æœ«å°¾åˆ†å· | `flyux_normalize()` (line 268) | æ¯ä¸ªåˆ†å‰²çš„è¯­å¥å |

### 4.2 å½“å‰é€»è¾‘çš„ç¼ºé™·

**ç¼ºé™·**ï¼šåªå¤„ç†**æœ‰æ¢è¡Œçš„**è¯­å¥ï¼Œå¯¹äº**å—ç›¸é‚»**ï¼ˆ`}{`ï¼‰æˆ–**å—æœ«å°¾**çš„è¯­å¥æ— æ³•æ·»åŠ åˆ†å·

**ç‰¹åˆ«æ˜¯**ï¼š
- å½“å—æœ«å°¾çš„è¯­å¥æ²¡æœ‰æ¢è¡Œæ—¶ï¼Œæ— æ³•æ£€æµ‹åˆ°éœ€è¦åˆ†å·
- åªæœ‰ `brace_depth == 1` æ—¶æ‰æœ‰ç‰¹æ®Šå¤„ç†ï¼ŒåµŒå¥—å—ï¼ˆå¦‚ if å—ï¼‰å†…æ²¡æœ‰ç±»ä¼¼å¤„ç†

---

## äº”ã€ä¿®å¤æ–¹æ¡ˆè®¾è®¡

### 5.1 æ ¸å¿ƒæ€è·¯

åœ¨ `normalize_internal_newlines()` ä¸­ï¼Œå¢å¼ºå¯¹ `}` çš„å¤„ç†ï¼š

**å½“é‡åˆ° `}` æ—¶**ï¼š
1. æ£€æŸ¥å‰é¢ï¼ˆå›åˆ°æœ€åä¸€ä¸ªéç©ºå­—ç¬¦ï¼‰
2. å¦‚æœä¸æ˜¯ `;` ä¸”ä¸æ˜¯ `{`ï¼Œè¯´æ˜å‰é¢æœ‰æœªç»“å°¾çš„è¯­å¥
3. æ·»åŠ åˆ†å·

è¿™æ ·å¯ä»¥**æ— è®ºæ˜¯å¦æœ‰æ¢è¡Œï¼Œéƒ½èƒ½åœ¨å—æœ«å°¾æ·»åŠ åˆ†å·**

### 5.2 å…·ä½“æ”¹è¿›

åœ¨ `normalize_internal_newlines()` ç¬¬ 115-127 è¡Œçš„é€»è¾‘ä¸­ï¼š

```c
if (ch == '}') {
    // ç°æœ‰é€»è¾‘ï¼šåªå¤„ç† brace_depth == 1 çš„æƒ…å†µ
    if (brace_depth == 1 && is_closing_function_body(...)) {
        æ·»åŠ åˆ†å·
    }
    
    // æ–°å¢é€»è¾‘ï¼šå¯¹æ‰€æœ‰å—çš„é—­æ‹¬å·è¿›è¡Œæ£€æŸ¥
    // æ£€æŸ¥å‰é¢æ˜¯å¦éœ€è¦åˆ†å·ï¼ˆä¸ä»…ä»…æ˜¯å‡½æ•°ä½“æœ«å°¾ï¼‰
    if (brace_depth > 0) {  // ä»»ä½•å—çš„é—­æ‹¬å·
        int last = out_idx - 1;
        while (last >= 0 && (result[last] == ' ' || ...)) {
            last--;
        }
        if (last >= 0 && result[last] != ';' && result[last] != '{') {
            æ·»åŠ åˆ†å·
        }
    }
    
    brace_depth--;
    result[out_idx++] = ch;
}
```

### 5.3 ä¿®å¤çš„è¦†ç›–èŒƒå›´

è¿™ä¸ªä¿®å¤ä¼šå¤„ç†ï¼š
1. âœ“ if å—æœ«å°¾çš„è¯­å¥ï¼ˆ`}{` ç›¸é‚»æ—¶ï¼‰
2. âœ“ else if å—æœ«å°¾çš„è¯­å¥
3. âœ“ else å—æœ«å°¾çš„è¯­å¥
4. âœ“ å¾ªç¯å—ï¼ˆfor, whileï¼‰æœ«å°¾çš„è¯­å¥
5. âœ“ ä»»ä½•åµŒå¥—å—æœ«å°¾çš„è¯­å¥

### 5.4 éœ€è¦æ³¨æ„çš„è¾¹ç•Œæƒ…å†µ

1. **ç©ºå—**ï¼š`{}` â†’ ä¸åº”æ·»åŠ åˆ†å·ï¼ˆå·²å¤„ç†ï¼Œå‰é¢æ˜¯ `{`ï¼‰
2. **åµŒå¥—å—**ï¼š`{{...};}`  â†’ æ­£ç¡®å¤„ç†ï¼ˆæ¯å±‚éƒ½æ£€æŸ¥ï¼‰
3. **å¯¹è±¡å­—é¢é‡**ï¼š`{a:1}` â†’ åº”è¯¥ä¿æŠ¤ï¼Œä¸æ·»åŠ åˆ†å·
   - ä½†è¿™é€šå¸¸ä½œä¸ºè¯­å¥æœ«å°¾ï¼š`x := {a:1}` æœ«å°¾æœ‰åˆ†å·
   - å¯¹è±¡æœ¬èº« `{a:1}` æœ«å°¾ä¸åº”æœ‰é¢å¤–åˆ†å·

### 5.5 å®ç°ä½ç½®

**æ–‡ä»¶**ï¼š`src/core/normalize.c`
**å‡½æ•°**ï¼š`normalize_internal_newlines()`
**ä½ç½®**ï¼šç¬¬ 114-135 è¡Œï¼Œåœ¨å¤„ç† `}` æ—¶å¢åŠ é€»è¾‘

---

## å…­ã€æ€»ç»“

### å½“å‰çŠ¶æ€
- åªå¤„ç†**æœ‰æ¢è¡Œ**çš„è¯­å¥
- å¯¹å—æœ«å°¾çš„è¯­å¥ï¼ˆå°¤å…¶æ˜¯å—ç›¸é‚»æ—¶ï¼‰æ— æ³•è‡ªåŠ¨æ·»åŠ åˆ†å·

### ä¿®å¤æ–¹å‘
- å¢å¼º `}` å¤„ç†é€»è¾‘
- å¯¹æ‰€æœ‰å—ï¼ˆä¸ä»…ä»…æ˜¯ `brace_depth==1`ï¼‰æ£€æŸ¥é—­æ‹¬å·å‰çš„è¯­å¥æ˜¯å¦éœ€è¦åˆ†å·
- ç¡®ä¿æ— è®ºæœ‰æ— æ¢è¡Œï¼Œå—æœ«å°¾çš„è¯­å¥éƒ½èƒ½æ­£ç¡®æ·»åŠ åˆ†å·

### é¢„æœŸæ•ˆæœ
```
if(...){...;}{...;};  âœ“
L>(...){...;}{...;}   âœ“
x:={...};             âœ“
```
