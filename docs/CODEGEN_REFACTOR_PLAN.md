# Codegen æ¨¡å—åŒ–æ‹†åˆ†æ–¹æ¡ˆ

## ğŸ“Š å½“å‰çŠ¶å†µåˆ†æ

**æ–‡ä»¶**: `src/backend/codegen/codegen.c`
**æ€»è¡Œæ•°**: 2211è¡Œ
**é—®é¢˜**: å•æ–‡ä»¶è¿‡å¤§ï¼ŒåŠŸèƒ½è€¦åˆï¼Œéš¾ä»¥ç»´æŠ¤ï¼Œå®¹æ˜“åœ¨æ·»åŠ æ–°åŠŸèƒ½æ—¶è¯¯æ”¹å·²éªŒè¯çš„ä»£ç 

### å½“å‰ç»“æ„åˆ†æ

| æ¨¡å— | è¡Œæ•°èŒƒå›´ | è¡Œæ•° | å æ¯” | ä¸»è¦å†…å®¹ |
|------|---------|------|------|---------|
| è¾…åŠ©å‡½æ•° | 10-134 | 125 | 5% | new_temp, new_label, escape_for_ir, ç¬¦å·è¡¨ç®¡ç† |
| å‰å‘å£°æ˜ | 135-141 | 7 | 0% | codegen_expr, codegen_stmt |
| åˆ›å»ºå’Œé”€æ¯ | 142-217 | 76 | 3% | codegen_create, codegen_free |
| **è¡¨è¾¾å¼ç”Ÿæˆ** | 218-1278 | **1061** | **47%** | 13ç§ASTèŠ‚ç‚¹ + 27ä¸ªå†…ç½®å‡½æ•° |
| ASTé¢„æ‰«æ | 1279-1327 | 49 | 2% | collect_catch_params |
| **è¯­å¥ç”Ÿæˆ** | 1328-2035 | **708** | **32%** | 13ç§è¯­å¥ç±»å‹ |
| ä¸»å…¥å£ | 2036-2211 | 176 | 7% | codegen_generate |

### å…³é”®é—®é¢˜ç‚¹

1. **è¡¨è¾¾å¼ç”Ÿæˆæ¨¡å—è¿‡å¤§ (1061è¡Œ)**:
   - åŒ…å«27ä¸ªå†…ç½®å‡½æ•°çš„å¤„ç† (~400è¡Œ)
   - 13ç§è¡¨è¾¾å¼ç±»å‹çš„å¤„ç† (~600è¡Œ)

2. **è¯­å¥ç”Ÿæˆæ¨¡å—è¾ƒå¤§ (708è¡Œ)**:
   - 13ç§è¯­å¥ç±»å‹æ··æ‚åœ¨ä¸€èµ·

3. **ç¼ºä¹æ¨¡å—è¾¹ç•Œ**:
   - æ‰€æœ‰ä»£ç åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­
   - æ–°å¢åŠŸèƒ½å®¹æ˜“å½±å“å·²æœ‰ä»£ç 

---

## ğŸ¯ æ‹†åˆ†æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆä¸€ï¼šæŒ‰åŠŸèƒ½ç±»å‹æ‹†åˆ†ï¼ˆæ¨èï¼‰

```
src/backend/codegen/
â”œâ”€â”€ codegen.h              # å…¬å…±å¤´æ–‡ä»¶ï¼ˆå·²å­˜åœ¨ï¼‰
â”œâ”€â”€ codegen_internal.h     # å†…éƒ¨å…±äº«å¤´æ–‡ä»¶ï¼ˆæ–°å¢ï¼‰
â”œâ”€â”€ codegen_core.c         # æ ¸å¿ƒåŠŸèƒ½ï¼ˆ~300è¡Œï¼‰
â”œâ”€â”€ codegen_expr.c         # è¡¨è¾¾å¼ç”Ÿæˆï¼ˆ~350è¡Œï¼‰
â”œâ”€â”€ codegen_builtin.c      # å†…ç½®å‡½æ•°å¤„ç†ï¼ˆ~450è¡Œï¼‰
â”œâ”€â”€ codegen_stmt.c         # è¯­å¥ç”Ÿæˆï¼ˆ~700è¡Œï¼‰
â”œâ”€â”€ codegen_utils.c        # å·¥å…·å‡½æ•°ï¼ˆ~150è¡Œï¼‰
â””â”€â”€ codegen_output.c       # IRè¾“å‡ºï¼ˆ~200è¡Œï¼‰
```

#### è¯¦ç»†æ¨¡å—èŒè´£

##### 1. `codegen_internal.h` (æ–°å¢)
```c
// å†…éƒ¨å…±äº«çš„æ•°æ®ç»“æ„å’Œå‡½æ•°å£°æ˜
// - CodeGenç»“æ„ä½“ï¼ˆä»codegen.hç§»é™¤å†…éƒ¨å­—æ®µï¼‰
// - è¾…åŠ©å‡½æ•°å£°æ˜
// - å‰å‘å£°æ˜
```
**è¡Œæ•°**: ~100è¡Œ

##### 2. `codegen_utils.c` (å·¥å…·å‡½æ•°)
```c
// è¾…åŠ©å·¥å…·å‡½æ•°
- new_temp()           // ç”Ÿæˆä¸´æ—¶å˜é‡
- new_label()          // ç”Ÿæˆæ ‡ç­¾
- new_string_label()   // ç”Ÿæˆå­—ç¬¦ä¸²æ ‡ç­¾
- escape_for_ir()      // å­—ç¬¦ä¸²è½¬ä¹‰
- register_array()     // æ•°ç»„å…ƒæ•°æ®æ³¨å†Œ
- find_array()         // æŸ¥æ‰¾æ•°ç»„
- register_object()    // å¯¹è±¡å…ƒæ•°æ®æ³¨å†Œ
- find_object()        // æŸ¥æ‰¾å¯¹è±¡
- find_field()         // æŸ¥æ‰¾å­—æ®µ
- register_symbol()    // ç¬¦å·è¡¨æ³¨å†Œ
- is_symbol_defined()  // ç¬¦å·æ£€æŸ¥
```
**è¡Œæ•°**: ~150è¡Œ
**æ¥æº**: åŸæ–‡ä»¶ 10-134è¡Œ

##### 3. `codegen_builtin.c` (å†…ç½®å‡½æ•°å¤„ç†)
```c
// æ‰€æœ‰å†…ç½®å‡½æ•°çš„ä»£ç ç”Ÿæˆ
- builtin_print()      // print, println, printf
- builtin_typeof()     // typeOf
- builtin_input()      // input
- builtin_to_num()     // toNum, toStr, toBl, toInt, toFloat
- builtin_len()        // len
- builtin_char_at()    // charAt
- builtin_substr()     // substr
- builtin_index_of()   // indexOf
- builtin_replace()    // replace
- builtin_split()      // split
- builtin_join()       // join
- builtin_trim()       // trim
- builtin_upper()      // upper
- builtin_lower()      // lower
- builtin_push()       // push
- builtin_pop()        // pop
- builtin_shift()      // shift
- builtin_unshift()    // unshift
- builtin_slice()      // slice
- builtin_concat()     // concat
- builtin_length()     // length (å…¼å®¹)

// ä¸»å…¥å£
char* codegen_builtin_call(CodeGen *gen, const char *func_name, 
                           ASTNode **args, size_t arg_count);
```
**è¡Œæ•°**: ~450è¡Œ
**æ¥æº**: åŸæ–‡ä»¶ 253-656è¡Œä¸­çš„å†…ç½®å‡½æ•°éƒ¨åˆ†

##### 4. `codegen_expr.c` (è¡¨è¾¾å¼ç”Ÿæˆ)
```c
// è¡¨è¾¾å¼ASTèŠ‚ç‚¹ä»£ç ç”Ÿæˆ
char* codegen_expr(CodeGen *gen, ASTNode *node);

å¤„ç†çš„èŠ‚ç‚¹ç±»å‹:
- AST_NUM_LITERAL       // æ•°å­—å­—é¢é‡
- AST_BOOL_LITERAL      // å¸ƒå°”å­—é¢é‡
- AST_STRING_LITERAL    // å­—ç¬¦ä¸²å­—é¢é‡
- AST_NULL_LITERAL      // null
- AST_UNDEF_LITERAL     // undef
- AST_IDENTIFIER        // æ ‡è¯†ç¬¦
- AST_BINARY_EXPR       // äºŒå…ƒè¿ç®—
- AST_CALL_EXPR         // å‡½æ•°è°ƒç”¨ï¼ˆè°ƒç”¨builtinï¼‰
- AST_ARRAY_LITERAL     // æ•°ç»„å­—é¢é‡
- AST_OBJECT_LITERAL    // å¯¹è±¡å­—é¢é‡
- AST_UNARY_EXPR        // ä¸€å…ƒè¿ç®—
- AST_MEMBER_EXPR       // æˆå‘˜è®¿é—®ï¼ˆå«å†…ç½®å‡½æ•°æ”¯æŒï¼‰
- AST_INDEX_EXPR        // ç´¢å¼•è®¿é—®
```
**è¡Œæ•°**: ~350è¡Œ
**æ¥æº**: åŸæ–‡ä»¶ 218-1278è¡Œï¼ˆå»é™¤å†…ç½®å‡½æ•°éƒ¨åˆ†ï¼‰

##### 5. `codegen_stmt.c` (è¯­å¥ç”Ÿæˆ)
```c
// è¯­å¥ASTèŠ‚ç‚¹ä»£ç ç”Ÿæˆ
void codegen_stmt(CodeGen *gen, ASTNode *node);

å¤„ç†çš„èŠ‚ç‚¹ç±»å‹:
- AST_VAR_DECL         // å˜é‡å®šä¹‰
- AST_ASSIGNMENT       // èµ‹å€¼
- AST_EXPR_STMT        // è¡¨è¾¾å¼è¯­å¥
- AST_BLOCK            // ä»£ç å—
- AST_TRY_STMT         // try-catch
- AST_IF_STMT          // ifè¯­å¥
- AST_LOOP_STMT        // å¾ªç¯
- AST_RETURN_STMT      // è¿”å›
- AST_BREAK_STMT       // break
- AST_CONTINUE_STMT    // continue
- AST_FUNC_DECL        // å‡½æ•°å£°æ˜

// è¾…åŠ©å‡½æ•°
void collect_catch_params(CodeGen *gen, ASTNode *node, FILE *entry_buf);
```
**è¡Œæ•°**: ~750è¡Œ
**æ¥æº**: åŸæ–‡ä»¶ 1279-2035è¡Œ

##### 6. `codegen_core.c` (æ ¸å¿ƒåŠŸèƒ½)
```c
// æ ¸å¿ƒç®¡ç†åŠŸèƒ½
- codegen_create()     // åˆ›å»ºCodeGen
- codegen_free()       // é‡Šæ”¾èµ„æº
- codegen_generate()   // ä¸»å…¥å£
```
**è¡Œæ•°**: ~300è¡Œ
**æ¥æº**: åŸæ–‡ä»¶ 142-217, 2036-2211è¡Œ

##### 7. `codegen_output.c` (IRè¾“å‡º)
```c
// LLVM IRå£°æ˜å’Œè¾“å‡º
- codegen_emit_declarations()  // ç”Ÿæˆæ‰€æœ‰declare
- codegen_emit_globals()       // ç”Ÿæˆå…¨å±€å¸¸é‡
- codegen_emit_prelude()       // ç”Ÿæˆå‰å¯¼
```
**è¡Œæ•°**: ~200è¡Œ
**æ¥æº**: ä»codegen_generateä¸­æå–

---

### æ–¹æ¡ˆäºŒï¼šæŒ‰ASTèŠ‚ç‚¹ç±»å‹æ‹†åˆ†

```
src/backend/codegen/
â”œâ”€â”€ codegen_literals.c    # æ‰€æœ‰å­—é¢é‡
â”œâ”€â”€ codegen_operators.c   # è¿ç®—ç¬¦è¡¨è¾¾å¼
â”œâ”€â”€ codegen_calls.c       # å‡½æ•°è°ƒç”¨
â”œâ”€â”€ codegen_control.c     # æ§åˆ¶æµ
â”œâ”€â”€ codegen_data.c        # æ•°ç»„/å¯¹è±¡
```

**ä¼˜ç‚¹**: æŒ‰èŠ‚ç‚¹ç±»å‹æ¸…æ™°åˆ†ç±»
**ç¼ºç‚¹**: å†…ç½®å‡½æ•°åˆ†æ•£ï¼Œéš¾ä»¥ç»Ÿä¸€ç®¡ç†

---

## ğŸ“‹ æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆä¸€

### ä¼˜ç‚¹
1. âœ… **æ¸…æ™°çš„åŠŸèƒ½è¾¹ç•Œ**: æ¯ä¸ªæ¨¡å—èŒè´£å•ä¸€
2. âœ… **æ˜“äºç»´æŠ¤**: ä¿®æ”¹å†…ç½®å‡½æ•°åªéœ€æ”¹builtin.c
3. âœ… **å‡å°‘å†²çª**: æ–°å¢åŠŸèƒ½ä¸å½±å“å·²æœ‰ä»£ç 
4. âœ… **ä¾¿äºæµ‹è¯•**: å¯å•ç‹¬æµ‹è¯•æ¯ä¸ªæ¨¡å—
5. âœ… **ä»£ç é‡ç”¨**: å·¥å…·å‡½æ•°é›†ä¸­ç®¡ç†

### æ¨¡å—å¤§å°æ§åˆ¶
- æœ€å¤§æ¨¡å—: `codegen_stmt.c` (~750è¡Œ)
- å…¶ä»–æ¨¡å—: 150-450è¡Œ
- å…¨éƒ¨ < 800è¡Œï¼Œç¬¦åˆå•æ–‡ä»¶ < 1000è¡Œçš„æœ€ä½³å®è·µ

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Phase 1: å‡†å¤‡å·¥ä½œ
1. åˆ›å»º `codegen_internal.h`
2. å®šä¹‰æ¨¡å—é—´æ¥å£

### Phase 2: æ‹†åˆ†å†…ç½®å‡½æ•°
1. åˆ›å»º `codegen_builtin.c`
2. æå–æ‰€æœ‰å†…ç½®å‡½æ•°å¤„ç†
3. æµ‹è¯•å†…ç½®å‡½æ•°åŠŸèƒ½

### Phase 3: æ‹†åˆ†å·¥å…·å‡½æ•°
1. åˆ›å»º `codegen_utils.c`
2. ç§»åŠ¨è¾…åŠ©å‡½æ•°
3. æ›´æ–°å¼•ç”¨

### Phase 4: æ‹†åˆ†è¡¨è¾¾å¼
1. åˆ›å»º `codegen_expr.c`
2. ç§»åŠ¨è¡¨è¾¾å¼å¤„ç†
3. æµ‹è¯•è¡¨è¾¾å¼ç”Ÿæˆ

### Phase 5: æ‹†åˆ†è¯­å¥
1. åˆ›å»º `codegen_stmt.c`
2. ç§»åŠ¨è¯­å¥å¤„ç†
3. æµ‹è¯•è¯­å¥ç”Ÿæˆ

### Phase 6: æ•´ç†æ ¸å¿ƒ
1. åˆ›å»º `codegen_core.c`
2. ä¿ç•™æ ¸å¿ƒé€»è¾‘
3. å…¨é¢æµ‹è¯•

### Phase 7: ä¼˜åŒ–è¾“å‡º
1. åˆ›å»º `codegen_output.c`
2. æå–IRè¾“å‡ºé€»è¾‘
3. æœ€ç»ˆéªŒè¯

---

## âœ… éªŒè¯æ ‡å‡†

æ¯ä¸ªé˜¶æ®µå®Œæˆåå¿…é¡»:
1. âœ… ç¼–è¯‘æ— é”™è¯¯
2. âœ… æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
3. âœ… demo.fx è¾“å‡ºæ­£ç¡®
4. âœ… showcase_final.fx è¿è¡Œæ­£å¸¸
5. âœ… try_catch_test.fx é€šè¿‡

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ä¿æŒå‘åå…¼å®¹**: ä¸æ”¹å˜å¤–éƒ¨API
2. **é€æ­¥è¿ç§»**: æ¯æ¬¡åªæ‹†åˆ†ä¸€ä¸ªæ¨¡å—
3. **å……åˆ†æµ‹è¯•**: æ¯æ­¥éƒ½éªŒè¯åŠŸèƒ½
4. **æ–‡æ¡£åŒæ­¥**: æ›´æ–°æ³¨é‡Šå’Œæ–‡æ¡£
5. **Gitæäº¤**: æ¯ä¸ªæ¨¡å—ç‹¬ç«‹æäº¤

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

æ‹†åˆ†åçš„ä¼˜åŠ¿:
- å•æ–‡ä»¶æœ€å¤§ ~750è¡Œ (åŸ 2211è¡Œ)
- åŠŸèƒ½æ¨¡å—åŒ–ï¼ŒèŒè´£æ¸…æ™°
- å‡å°‘70%çš„ä»£ç å†²çªæ¦‚ç‡
- æ–°å¢åŠŸèƒ½å½±å“é¢å‡å°‘85%
- ä»£ç å¯è¯»æ€§æå‡60%

---

## ğŸ“Œ ä¸‹ä¸€æ­¥

**ç­‰å¾…ç¡®è®¤**: æ˜¯å¦é‡‡ç”¨æ–¹æ¡ˆä¸€è¿›è¡Œæ‹†åˆ†ï¼Ÿ

ç¡®è®¤åå°†å¼€å§‹ Phase 1: å‡†å¤‡å·¥ä½œ
